# 🎯 后台管理 - 文件资源管理快速指南

**功能状态**: ✅ 已部署并可用  
**访问路径**: `/admin/resources`  
**权限要求**: 管理员 (admin)

---

## 📱 如何访问

### 方式一：通过菜单
1. 登录管理员账号
2. 访问后台: `http://localhost:3000/admin`
3. 在左侧菜单找到 📁 **资源管理**
4. 点击进入资源管理页面

### 方式二：直接访问
```
http://localhost:3000/admin/resources
```

---

## 🎨 页面功能

### 1️⃣ 存储空间概览

顶部的统计卡片展示：

```
┌──────────────┬──────────────┬──────────────┬──────────────┐
│ 💾 总存储占用 │ 🎵 音频文件   │ 🖼️ 封面图片   │ 🗑️ 回收站     │
│ 1.5GB (30%)  │ 82 个        │ 29 个        │ 103 个       │
│ ████░░░░░░   │ 占用 1.4GB   │ 占用 20MB    │ 占用 1.3GB   │
└──────────────┴──────────────┴──────────────┴──────────────┘
```

**功能说明**:
- 实时显示存储使用情况
- 进度条警告（超过 80% 显示红色）
- 点击"刷新"按钮更新数据

---

### 2️⃣ 孤儿文件清理 (Tab 1)

**什么是孤儿文件？**
> 存在于文件系统中，但数据库里没有引用记录的文件。
> 通常由上传失败、删除不完整等原因产生。

**操作步骤**:

```
第1步: 点击 [检测孤儿文件] 按钮
       ↓
第2步: 等待扫描完成（显示文件列表）
       ↓
第3步: 查看孤儿文件详情
       - 文件路径
       - 类型（音频/封面）
       - 文件大小
       - 修改时间
       ↓
第4步: 点击 [清理到回收站 (N)] 按钮
       ↓
第5步: 确认清理操作
       ↓
第6步: ✅ 完成！文件已移动到回收站
```

**安全特性**:
- ✅ 文件移动到回收站，不是直接删除
- ✅ 需要二次确认
- ✅ 显示详细的清理报告

**示例输出**:
```
✅ 发现 103 个孤儿文件
   总大小: 1.33 GB

   文件列表:
   📁 /uploads/audios/2025/08/xxx.wav    音频  15.2 MB  2025-01-15
   📁 /uploads/covers/xxx.jpg            封面  120 KB   2025-01-16
   ...
```

---

### 3️⃣ 存储分析 (Tab 2)

**按类型分布**:
- 🎵 音频文件占比: 85%
- 🖼️ 封面图片占比: 10%
- 📁 其他文件占比: 5%

**按分类分布**:
```
内科学:  15 个文件, 占用 250 MB
外科学:  12 个文件, 占用 198 MB
儿科学:  8 个文件,  占用 135 MB
...
```

---

### 4️⃣ 维护工具 (Tab 3)

提供了三个维护工具的说明：

1. **文件整理工具**
   - 功能: 将文件按年/月组织
   - 命令: `node scripts/organize-files.js --verbose`
   - 状态: 可通过命令行使用

2. **清空回收站**
   - 功能: 删除回收站中的文件
   - 状态: 开发中（当前可通过命令行）

3. **数据库同步检查**
   - 功能: 修复数据库与文件不一致
   - 状态: 开发中

---

## 🔥 快速使用场景

### 场景 1: 存储空间不足

```bash
# 问题: 存储使用率达到 85%

解决方案:
1. 访问 /admin/resources
2. 切换到"孤儿文件清理"
3. 点击"检测孤儿文件"
4. 清理发现的孤儿文件
5. 检查回收站，确认可以删除
6. 通过命令清空回收站:
   find public/uploads/trash -type f -mtime +30 -delete
```

### 场景 2: 定期维护

```bash
# 每周维护任务

步骤:
1. 登录后台管理
2. 访问资源管理页面
3. 运行孤儿文件检测
4. 查看存储分析
5. 记录存储使用趋势
```

### 场景 3: 上传后检查

```bash
# 批量上传音频后检查

步骤:
1. 完成音频上传
2. 访问资源管理
3. 刷新存储统计
4. 检查是否有上传失败的文件
5. 如有孤儿文件，及时清理
```

---

## 🛠️ API 端点

### 1. 获取存储统计
```bash
GET /api/admin/storage/stats

响应示例:
{
  "totalSize": 1610612736,
  "audioSize": 1500000000,
  "audioCount": 82,
  "coverSize": 20971520,
  "coverCount": 29,
  "trashSize": 1395864371,
  "trashCount": 103
}
```

### 2. 检测孤儿文件
```bash
GET /api/admin/storage/orphans

响应示例:
{
  "success": true,
  "orphans": [
    {
      "path": "/uploads/audios/xxx.wav",
      "size": 15728640,
      "type": "audio",
      "mtime": "2025-01-15T10:30:00.000Z"
    }
  ],
  "count": 103,
  "totalSize": 1395864371
}
```

### 3. 清理孤儿文件
```bash
POST /api/admin/storage/cleanup
Content-Type: application/json

{
  "orphans": [
    {
      "path": "/uploads/audios/xxx.wav",
      "size": 15728640,
      "type": "audio",
      "mtime": "2025-01-15T10:30:00.000Z"
    }
  ]
}

响应示例:
{
  "success": true,
  "cleaned": 103,
  "total": 103
}
```

---

## 📊 监控建议

### 每日检查
```bash
# 快速查看存储状态
du -sh public/uploads/
```

### 每周任务
```bash
# 1. 访问资源管理页面
# 2. 运行孤儿文件检测
# 3. 清理发现的孤儿文件
```

### 每月任务
```bash
# 1. 清空回收站（30天前的文件）
find public/uploads/trash -type f -mtime +30 -delete

# 2. 审查存储趋势
# 3. 规划容量扩展
```

---

## ⚠️ 注意事项

### ✅ 安全操作
- 清理前务必检查孤儿文件列表
- 回收站文件保留至少 30 天再删除
- 定期备份重要数据

### ⚠️ 避免的操作
- ❌ 不要手动删除 uploads 目录中的文件
- ❌ 不要跳过孤儿文件检测直接删除
- ❌ 不要在高峰期执行大规模清理

### 💡 最佳实践
- ✅ 使用孤儿文件检测功能
- ✅ 文件先移到回收站
- ✅ 保持 80% 以下的存储使用率
- ✅ 每周检查一次

---

## 🐛 故障排查

### 问题 1: 页面显示 403 错误
```
原因: 没有管理员权限
解决: 使用 admin 角色的账号登录
```

### 问题 2: 孤儿文件检测失败
```
原因: 数据库连接失败或文件权限问题
解决:
1. 检查数据库连接
2. 检查 uploads 目录权限: chmod -R 755 public/uploads/
```

### 问题 3: 清理操作失败
```
原因: 文件系统权限不足
解决:
1. 检查文件权限
2. 确保 trash 目录存在且可写
```

### 问题 4: 存储统计不准确
```
原因: 缓存或文件系统延迟
解决: 点击"刷新"按钮重新加载数据
```

---

## 📚 相关命令

### 查看存储详情
```bash
# 查看各目录大小
du -h public/uploads/* | sort -h

# 查看文件数量
find public/uploads/audios -type f | wc -l
find public/uploads/covers -type f | wc -l
```

### 手动整理文件
```bash
# 运行整理脚本
node scripts/organize-files.js --verbose

# 预览模式（不实际移动）
node scripts/organize-files.js --dry-run --verbose
```

### 手动清理孤儿文件
```bash
# 运行清理脚本
node scripts/cleanup-orphan-files.js --verbose

# 预览模式
node scripts/cleanup-orphan-files.js --dry-run --verbose
```

### 管理回收站
```bash
# 查看回收站内容
ls -lh public/uploads/trash/

# 清空回收站（30天前）
find public/uploads/trash -type f -mtime +30 -delete

# 完全清空回收站（谨慎！）
rm -rf public/uploads/trash/*
```

---

## 🎓 学习资源

- [完整资源管理方案](./AUDIO_RESOURCE_MANAGEMENT_GUIDE.md)
- [资源管理快速开始](./RESOURCE_MANAGEMENT_QUICK_START.md)
- [功能详细说明](./ADMIN_RESOURCES_MENU_ADDED.md)
- [执行报告](./RESOURCE_MANAGEMENT_EXECUTION_REPORT.md)

---

## 💬 常见问题

**Q: 孤儿文件可以恢复吗？**
A: 可以！清理操作只是将文件移动到回收站，30天内可以手动恢复。

**Q: 多久运行一次孤儿文件检测？**
A: 建议每周运行一次，或在大量上传操作后立即检查。

**Q: 清理操作会影响正在使用的文件吗？**
A: 不会！只会清理数据库中没有引用的文件，活动文件不受影响。

**Q: 存储空间警告阈值是多少？**
A: 当使用率超过 80% 时会显示警告，建议保持在 80% 以下。

**Q: 可以自定义存储路径吗？**
A: 当前版本使用固定路径 `public/uploads/`，未来版本将支持自定义。

---

**更新日期**: 2025-10-04  
**版本**: v1.0.0  
**维护**: Admin Team

🎉 享受高效的资源管理体验！

