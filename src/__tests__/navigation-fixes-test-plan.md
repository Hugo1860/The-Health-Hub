# Navigation Fixes Test Plan

## 测试概述

本文档描述了导航修复功能的测试计划，包括基于角色的导航和错误处理功能的测试用例。

## 1. 基于角色的导航测试

### 1.1 管理员用户导航测试

**测试用例 1.1.1: 管理员用户看到正确的菜单标签**
- **前置条件**: 用户以管理员身份登录
- **测试步骤**:
  1. 登录系统
  2. 点击用户头像打开下拉菜单
- **预期结果**: 设置菜单项显示为"管理后台"

**测试用例 1.1.2: 管理员用户点击设置导航到管理页面**
- **前置条件**: 用户以管理员身份登录
- **测试步骤**:
  1. 登录系统
  2. 点击用户头像打开下拉菜单
  3. 点击"管理后台"菜单项
- **预期结果**: 页面导航到 `/admin` 路径

### 1.2 普通用户导航测试

**测试用例 1.2.1: 普通用户看到正确的菜单标签**
- **前置条件**: 用户以普通用户身份登录
- **测试步骤**:
  1. 登录系统
  2. 点击用户头像打开下拉菜单
- **预期结果**: 设置菜单项显示为"设置"

**测试用例 1.2.2: 普通用户点击设置导航到设置页面**
- **前置条件**: 用户以普通用户身份登录
- **测试步骤**:
  1. 登录系统
  2. 点击用户头像打开下拉菜单
  3. 点击"设置"菜单项
- **预期结果**: 页面导航到 `/settings` 路径

### 1.3 边界情况测试

**测试用例 1.3.1: 未定义角色用户默认行为**
- **前置条件**: 用户登录但角色未定义
- **测试步骤**:
  1. 登录系统（角色为 undefined 或 null）
  2. 点击用户头像打开下拉菜单
  3. 点击设置菜单项
- **预期结果**: 
  - 菜单项显示为"设置"
  - 导航到 `/settings` 路径

## 2. Browse 页面错误处理测试

### 2.1 API 错误处理测试

**测试用例 2.1.1: 分类 API 失败时的回退行为**
- **测试步骤**:
  1. 模拟分类 API 返回 500 错误
  2. 访问 `/browse` 页面
- **预期结果**:
  - 页面显示默认分类
  - 显示错误提示但不阻止页面使用
  - 提供重试选项

**测试用例 2.1.2: 音频 API 失败时的错误显示**
- **测试步骤**:
  1. 模拟音频 API 返回网络错误
  2. 访问 `/browse` 页面
- **预期结果**:
  - 显示友好的错误消息
  - 提供重试按钮
  - 错误类型正确分类为网络错误

**测试用例 2.1.3: 网络断开时的处理**
- **测试步骤**:
  1. 断开网络连接
  2. 访问 `/browse` 页面
  3. 恢复网络连接
- **预期结果**:
  - 显示网络断开提示
  - 网络恢复后自动重试
  - 页面正常加载

### 2.2 重试机制测试

**测试用例 2.2.1: 自动重试功能**
- **测试步骤**:
  1. 模拟 API 前两次请求失败，第三次成功
  2. 访问 `/browse` 页面
- **预期结果**:
  - 系统自动重试失败的请求
  - 最终显示正确的数据
  - 重试过程对用户透明

**测试用例 2.2.2: 最大重试次数限制**
- **测试步骤**:
  1. 模拟 API 持续返回错误
  2. 访问 `/browse` 页面
- **预期结果**:
  - 达到最大重试次数后停止重试
  - 显示最终错误状态
  - 提供手动重试选项

**测试用例 2.2.3: 指数退避延迟**
- **测试步骤**:
  1. 模拟 API 错误并监控重试间隔
  2. 访问 `/browse` 页面
- **预期结果**:
  - 重试间隔呈指数增长
  - 包含随机抖动避免惊群效应

### 2.3 错误分类测试

**测试用例 2.3.1: 不同 HTTP 状态码的处理**
- **测试数据**:
  - 401: 认证错误，不可重试
  - 403: 权限错误，不可重试
  - 404: 资源不存在，不可重试
  - 429: 限流错误，可重试
  - 500: 服务器错误，可重试
  - 502/503/504: 网关错误，可重试
- **预期结果**: 每种错误显示相应的错误消息和重试策略

**测试用例 2.3.2: 错误严重程度分类**
- **测试步骤**: 触发不同类型的错误
- **预期结果**: 错误按严重程度正确分类（低、中、高、严重）

## 3. 加载状态测试

### 3.1 骨架加载器测试

**测试用例 3.1.1: 页面初始加载状态**
- **测试步骤**:
  1. 访问 `/browse` 页面
  2. 观察加载过程
- **预期结果**:
  - 显示页面骨架加载器
  - 加载完成后平滑过渡到实际内容

**测试用例 3.1.2: 组件级加载状态**
- **测试步骤**:
  1. 在页面加载后触发筛选操作
  2. 观察各组件的加载状态
- **预期结果**:
  - 筛选控件显示相应的骨架加载器
  - 音频网格显示骨架卡片

### 3.2 智能加载状态测试

**测试用例 3.2.1: 长时间加载的处理**
- **测试步骤**:
  1. 模拟长时间的 API 响应
  2. 观察加载状态变化
- **预期结果**:
  - 初始显示简单加载指示器
  - 2秒后显示进度条
  - 5秒后显示详细提示信息

## 4. 错误边界测试

### 4.1 组件错误边界测试

**测试用例 4.1.1: 组件渲染错误处理**
- **测试步骤**:
  1. 在组件中抛出渲染错误
  2. 观察错误边界的处理
- **预期结果**:
  - 错误被错误边界捕获
  - 显示友好的错误回退界面
  - 提供重试选项

**测试用例 4.1.2: 页面级错误边界**
- **测试步骤**:
  1. 在页面组件中抛出严重错误
  2. 观察页面级错误边界的处理
- **预期结果**:
  - 显示页面级错误界面
  - 提供返回首页选项
  - 错误信息被正确记录

### 4.2 错误恢复测试

**测试用例 4.2.1: 错误重置功能**
- **测试步骤**:
  1. 触发组件错误
  2. 点击重试按钮
- **预期结果**:
  - 组件重新渲染
  - 错误状态被清除

## 5. 性能测试

### 5.1 加载性能测试

**测试用例 5.1.1: 首次加载时间**
- **测试指标**: 页面首次内容绘制时间 (FCP)
- **预期结果**: FCP < 2秒

**测试用例 5.1.2: 交互响应时间**
- **测试指标**: 用户交互到页面响应的时间
- **预期结果**: 响应时间 < 100ms

### 5.2 错误处理性能测试

**测试用例 5.2.1: 错误处理不影响正常功能**
- **测试步骤**:
  1. 在一个组件中触发错误
  2. 测试其他组件的正常功能
- **预期结果**: 其他组件不受影响，正常工作

## 6. 可访问性测试

### 6.1 键盘导航测试

**测试用例 6.1.1: 错误状态的键盘可访问性**
- **测试步骤**:
  1. 使用键盘导航到错误状态
  2. 使用键盘操作重试按钮
- **预期结果**: 所有交互元素都可以通过键盘访问

### 6.2 屏幕阅读器测试

**测试用例 6.2.1: 错误消息的屏幕阅读器支持**
- **测试步骤**: 使用屏幕阅读器访问错误状态
- **预期结果**: 错误消息被正确朗读

## 7. 浏览器兼容性测试

### 7.1 主流浏览器测试

**测试范围**:
- Chrome (最新版本)
- Firefox (最新版本)
- Safari (最新版本)
- Edge (最新版本)

**测试用例**: 在每个浏览器中执行上述所有功能测试

### 7.2 移动端测试

**测试设备**:
- iOS Safari
- Android Chrome

**重点测试**:
- 触摸交互
- 响应式布局
- 移动端特定的错误处理

## 8. 自动化测试建议

### 8.1 单元测试

```javascript
// 示例：角色导航逻辑测试
describe('Role-based Navigation', () => {
  test('admin user should see admin dashboard link', () => {
    const user = { role: 'admin' };
    const menuItems = generateUserMenuItems(user);
    expect(menuItems.find(item => item.key === 'settings').label).toBe('管理后台');
  });

  test('regular user should see settings link', () => {
    const user = { role: 'user' };
    const menuItems = generateUserMenuItems(user);
    expect(menuItems.find(item => item.key === 'settings').label).toBe('设置');
  });
});
```

### 8.2 集成测试

```javascript
// 示例：API 错误处理测试
describe('API Error Handling', () => {
  test('should retry failed requests', async () => {
    const mockFetch = jest.fn()
      .mockRejectedValueOnce(new Error('Network error'))
      .mockResolvedValueOnce({ ok: true, json: () => Promise.resolve({}) });

    const result = await fetchWithRetry('/api/test');
    expect(mockFetch).toHaveBeenCalledTimes(2);
    expect(result.success).toBe(true);
  });
});
```

### 8.3 端到端测试

```javascript
// 示例：Playwright 测试
test('browse page error handling', async ({ page }) => {
  // 模拟网络错误
  await page.route('/api/audio', route => route.abort());
  
  await page.goto('/browse');
  
  // 验证错误状态显示
  await expect(page.locator('[data-testid="error-display"]')).toBeVisible();
  await expect(page.locator('text=重试')).toBeVisible();
  
  // 测试重试功能
  await page.unroute('/api/audio');
  await page.click('text=重试');
  
  // 验证页面恢复正常
  await expect(page.locator('[data-testid="audio-grid"]')).toBeVisible();
});
```

## 9. 测试数据准备

### 9.1 用户数据
- 管理员用户: `{ id: '1', role: 'admin', email: 'admin@test.com' }`
- 普通用户: `{ id: '2', role: 'user', email: 'user@test.com' }`
- 无角色用户: `{ id: '3', role: null, email: 'norole@test.com' }`

### 9.2 API 响应数据
- 成功响应示例
- 各种错误响应示例
- 空数据响应示例

## 10. 测试环境配置

### 10.1 测试工具推荐
- **单元测试**: Jest + React Testing Library
- **集成测试**: Jest + MSW (Mock Service Worker)
- **端到端测试**: Playwright 或 Cypress
- **性能测试**: Lighthouse CI
- **可访问性测试**: axe-core

### 10.2 CI/CD 集成
- 在每次 PR 时运行所有测试
- 在部署前运行完整的测试套件
- 定期运行性能和可访问性测试

## 11. 测试报告

测试完成后应生成包含以下内容的报告：
- 测试覆盖率
- 通过/失败的测试用例统计
- 性能指标
- 发现的问题和建议
- 回归测试结果

## 12. 维护和更新

- 定期更新测试用例以覆盖新功能
- 监控生产环境中的错误模式，更新测试用例
- 根据用户反馈调整测试重点
- 保持测试数据的时效性