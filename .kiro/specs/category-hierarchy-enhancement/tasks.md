# 分类层级管理功能实施计划

- [x] 1. 数据库结构更新和迁移
  - 为 categories 表添加层级支持字段（parent_id, level, sort_order, is_active）
  - 为 audios 表添加新的分类关联字段（category_id, subcategory_id）
  - 创建必要的索引和外键约束
  - 编写数据迁移脚本将现有数据转换为新结构
  - _需求: 1.1, 1.2, 1.3, 7.1, 7.2_

- [x] 2. 更新分类数据模型和类型定义
  - 创建新的 Category 接口，包含层级相关字段
  - 定义 CategoryTree 和 CategoryChild 接口
  - 实现分类验证规则和错误处理类型
  - 创建分类层级操作的工具函数
  - _需求: 1.1, 1.4, 8.1, 8.2_

- [x] 3. 实现分类层级查询和操作函数
  - 编写构建分类树的数据库查询函数
  - 实现分类层级验证逻辑（防止循环引用、深度限制）
  - 创建分类排序和重新排序功能
  - 实现分类删除前的依赖检查
  - _需求: 1.1, 1.4, 2.4, 8.1_

- [x] 4. 更新分类管理 API 接口
- [x] 4.1 更新 GET /api/categories 接口支持树形结构
  - 添加 format 参数支持 tree 和 flat 两种格式
  - 实现 includeInactive 和 includeCount 参数
  - 返回完整的分类层级数据
  - _需求: 6.1_

- [x] 4.2 更新 POST /api/categories 接口支持二级分类创建
  - 添加 parentId 参数支持
  - 实现层级验证和重名检查
  - 自动计算分类层级
  - _需求: 2.1, 2.2, 6.2_

- [x] 4.3 更新 PUT /api/categories/[id] 接口支持层级修改
  - 支持修改父分类关系
  - 实现层级变更的验证逻辑
  - 处理子分类的级联更新
  - _需求: 2.3, 6.2_

- [x] 4.4 更新 DELETE /api/categories/[id] 接口增强删除检查
  - 检查是否有子分类
  - 检查是否有关联音频
  - 提供强制删除选项（管理员）
  - _需求: 2.4, 6.5_

- [x] 4.5 创建新的分类树和排序 API 接口
  - 实现 GET /api/categories/tree 接口
  - 实现 POST /api/categories/reorder 接口
  - 添加批量操作支持
  - _需求: 6.1, 6.2_

- [x] 5. 更新音频分类关联功能
- [x] 5.1 更新音频查询 API 支持层级分类筛选
  - 在 GET /api/audio 接口添加 categoryId 和 subcategoryId 参数
  - 实现分类路径筛选功能
  - 优化查询性能
  - _需求: 3.3, 5.1, 5.2, 5.3_

- [x] 5.2 更新音频编辑 API 支持分类层级选择
  - 在 PUT /api/audio/[id] 接口添加分类层级字段
  - 实现分类一致性验证
  - 同步更新旧的 subject 字段以保持兼容性
  - _需求: 3.1, 3.2, 3.4_

- [x] 6. 创建前端分类选择组件
- [x] 6.1 实现 CategorySelector 组件
  - 创建层级分类选择器
  - 支持一级分类选择后显示二级分类
  - 实现清空和重置功能
  - 添加加载状态和错误处理
  - _需求: 3.1, 3.2_

- [x] 6.2 实现 CategoryTree 管理组件
  - 创建树形分类展示组件
  - 支持展开/折叠功能
  - 实现拖拽排序功能
  - 添加编辑和删除操作
  - _需求: 2.1, 2.2, 2.3_

- [x] 6.3 实现 CategoryBreadcrumb 导航组件
  - 创建分类路径面包屑组件
  - 支持点击导航到上级分类
  - 显示完整的分类层级路径
  - _需求: 4.4, 5.4_

- [x] 7. 更新分类管理界面
- [x] 7.1 重构分类管理页面支持层级展示
  - 将现有的平铺列表改为树形结构
  - 添加层级缩进和视觉指示
  - 实现分类层级的增删改操作
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 7.2 更新音频上传和编辑页面的分类选择
  - 替换现有的分类下拉框为层级选择器
  - 实现二级分类的联动选择
  - 添加分类预览和路径显示
  - _需求: 3.1, 3.2_

- [x] 8. 更新前端分类展示和导航
- [x] 8.1 更新首页分类导航支持层级结构
  - 重构分类导航组件显示层级结构
  - 实现一级分类的展开/折叠
  - 添加二级分类的悬停展示
  - _需求: 4.1, 4.2_

- [x] 8.2 更新音频列表页面的分类筛选
  - 添加层级分类筛选器
  - 实现分类路径的显示和导航
  - 优化筛选结果的展示
  - _需求: 4.3, 5.1, 5.2, 5.3_

- [x] 8.3 更新音频详情页面的分类显示
  - 显示完整的分类路径面包屑
  - 添加相关分类音频推荐
  - 实现分类标签的点击跳转
  - _需求: 4.4, 5.4_

- [x] 9. 实现数据迁移和兼容性处理
- [x] 9.1 创建数据迁移脚本
  - 编写将现有分类数据迁移到新结构的脚本
  - 实现音频分类关联的数据转换
  - 创建数据验证和修复工具
  - _需求: 7.1, 7.2, 7.4_

- [x] 9.2 实现向后兼容性支持
  - 保持现有 API 的兼容性
  - 实现新旧数据字段的同步机制
  - 创建渐进式迁移策略
  - _需求: 7.3, 7.4_

- [ ] 10. 添加性能优化和缓存
- [x] 10.1 实现分类树查询优化
  - 添加分类树的缓存机制
  - 优化数据库查询性能
  - 实现增量更新策略
  - _需求: 8.3_

- [x] 10.2 添加分类操作的性能监控
  - 实现查询性能监控
  - 添加慢查询告警
  - 创建性能分析工具
  - _需求: 8.3, 8.4_

- [ ] 11. 编写测试用例
- [ ] 11.1 创建分类层级功能的单元测试
  - 测试分类 CRUD 操作
  - 测试层级验证逻辑
  - 测试错误处理机制
  - _需求: 所有需求的验证_

- [ ] 11.2 创建 API 接口的集成测试
  - 测试分类管理 API 的完整流程
  - 测试音频分类关联功能
  - 测试数据一致性和并发安全
  - _需求: 所有需求的验证_

- [ ] 11.3 创建前端组件的测试用例
  - 测试分类选择组件的交互
  - 测试分类树组件的功能
  - 测试用户界面的响应性
  - _需求: 所有需求的验证_

- [ ] 12. 部署和上线准备
- [ ] 12.1 准备生产环境部署脚本
  - 创建数据库迁移脚本
  - 准备应用部署配置
  - 实现回滚机制
  - _需求: 7.1, 7.2, 7.3_

- [ ] 12.2 配置监控和告警
  - 设置性能监控指标
  - 配置错误告警机制
  - 创建运维文档
  - _需求: 8.3, 8.4_